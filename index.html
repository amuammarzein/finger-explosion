<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finger Explosion: Game AI yang bikin jari lo jadi senjata!</title>
    <link rel="icon" type="image/png" href="assets/fav.png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --p1-color: #00d2ff; --p2-color: #ff007f; --bg-glass: rgba(10, 10, 10, 0.85); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { width: 100vw; height: 100vh; object-fit: cover; transform: scaleX(-1); }

        .hud { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; z-index: 10; transition: 0.5s; }
        .score-box { padding: 10px 40px; border-radius: 20px; background: var(--bg-glass); border: 2px solid #fff; text-align: center; min-width: 150px; }
        .p1-ui { border-color: var(--p1-color); box-shadow: 0 0 20px var(--p1-color); color: var(--p1-color); }
        .p2-ui { border-color: var(--p2-color); box-shadow: 0 0 20px var(--p2-color); color: var(--p2-color); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #111 0%, #000 100%); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.5s; }
        
        #winner-display { 
            display: none; 
            background: rgba(0, 0, 0, 0.2); 
            backdrop-filter: blur(2px); 
            z-index: 100;
        }
        
        #winner-display .glass-panel { 
            background: rgba(0, 0, 0, 0.7); 
            border: 3px solid #fff;
            box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        .glass-panel { padding: 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        h1 { font-size: 3rem; margin-bottom: 20px; letter-spacing: 5px; text-shadow: 0 0 20px #fff; }
        
        input[type="number"] { background: #000; border: 2px solid var(--p1-color); color: #fff; padding: 15px; font-family: 'Orbitron'; font-size: 1.5rem; width: 100px; text-align: center; border-radius: 10px; margin: 20px 0; outline: none; }
        .btn-action { padding: 15px 50px; border-radius: 50px; border: none; background: linear-gradient(45deg, var(--p1-color), var(--p2-color)); color: white; font-family: 'Orbitron'; cursor: pointer; font-weight: bold; font-size: 1.2rem; transition: 0.3s; }
        .btn-action:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--p1-color); }

        /* UI Countdown */
        #countdown-ui {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 30px var(--p1-color), 0 0 60px var(--p2-color);
            z-index: 200;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>

<canvas id="output_canvas"></canvas>

<div id="countdown-ui">3</div>

<div id="start-menu" class="overlay">
    <div class="glass-panel">
        <h1>Finger Explosion</h1>
        <p style="color: #aaa;">SET WINNING SCORE</p>
        <input type="number" id="goal-input" value="10">
        <br>
        <select id="cam_select" style="margin-bottom: 20px; background:#222; color:#fff; border:none; padding:10px; border-radius:5px; font-family: 'Orbitron';"></select>
        <br>
        <button class="btn-action" onclick="startGame()">ENTER ARENA</button>
    </div>
</div>

<div id="winner-display" class="overlay">
    <div class="glass-panel">
        <h1 id="winner-name">PLAYER WINS!</h1>
        <button class="btn-action" onclick="location.reload()">REMATCH</button>
    </div>
</div>

<div class="hud" style="opacity: 0;">
    <div class="score-box p1-ui">
        <div>PLAYER 1</div>
        <div id="p1-score" style="font-size: 2.5rem;">0</div>
    </div>
    <div style="text-align: center;">
        <div style="color: #aaa;">GOAL</div>
        <div id="win-goal" style="font-size: 1.5rem;">10</div>
    </div>
    <div class="score-box p2-ui">
        <div>PLAYER 2</div>
        <div id="p2-score" style="font-size: 2.5rem;">0</div>
    </div>
</div>

<video id="input_video" style="display:none"></video>

<script>
    let scores = { p1: 0, p2: 0 }, winScore = 10;
    let isRunning = false;   
    let gameActive = false;  
    
    let hands, camera, canvasCtx, canvasElement;
    let targets = [];
    let particles = []; 
    let trailHistory = { p1: [], p2: [] }; 

    let smoothPos = {
        p1: { x: 0, y: 0, active: false },
        p2: { x: 0, y: 0, active: false }
    };
    const SMOOTH_FACTOR = 0.25;

    function lerp(start, end, amt) { return (1 - amt) * start + amt * end; }

    //https://pixabay.com/sound-effects/film-special-effects-sword-blade-slicing-flesh-352708/
    const sfxSlice = new Audio('assets/slice.mp3');
    // https://pixabay.com/sound-effects/film-special-effects-arcade-countdown-7007/
    const sfxStart = new Audio('assets/game-start.mp3');
    // https://pixabay.com/sound-effects/film-special-effects-winning-218995/
    const sfxOver = new Audio('assets/game-over.mp3');

    function playSfx(audio) {
        const sound = audio.cloneNode();
        sound.volume = 0.5;
        sound.play().catch(e => {});
    }

    function createExplosion(x, y, color) {
        for (let i = 0; i < 15; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 15,
                vy: (Math.random() - 0.5) * 15,
                life: 1.0, color: color,
                size: Math.random() * 5 + 2
            });
        }
    }

    function updateParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.03;
            if (p.life <= 0) particles.splice(i, 1);
            else {
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                canvasCtx.fillStyle = p.color;
                canvasCtx.globalAlpha = p.life;
                canvasCtx.fill();
            }
        }
        canvasCtx.globalAlpha = 1.0;
    }

    function init() {
        canvasElement = document.getElementById('output_canvas');
        canvasCtx = canvasElement.getContext('2d');
        hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        navigator.mediaDevices.enumerateDevices().then(devices => {
            devices.filter(d => d.kind === 'videoinput').forEach(d => {
                $('#cam_select').append(`<option value="${d.deviceId}">${d.label || 'Camera'}</option>`);
            });
        });
    }

    function createTarget(side) {
        const minX = side === 0 ? 0.55 : 0.05;
        const maxX = side === 0 ? 0.95 : 0.45;
        return {
            x: Math.random() * (maxX - minX) + minX,
            y: Math.random() * 0.6 + 0.2,
            baseX: Math.random() * (maxX - minX) + minX,
            baseY: Math.random() * 0.6 + 0.2,
            side: side, r: 35,
            color: side === 0 ? '#00d2ff' : '#ff007f',
            phase: Math.random() * 10, speed: 0.02 + Math.random() * 0.02,
            active: true
        };
    }

    function startGame() {
        // Reset state
        winScore = parseInt($('#goal-input').val()) || 10;
        $('#win-goal').text(winScore);
        targets = []; particles = []; scores = { p1: 0, p2: 0 };
        $('#p1-score').text(0);
        $('#p2-score').text(0);

        // UI Transition
        $('#start-menu').hide();
        $('.hud').css('opacity', '1');

        // Jalankan Kamera di Background (untuk tracking pas countdown)
        camera = new Camera(document.getElementById('input_video'), {
            onFrame: async () => { if(isRunning) await hands.send({image: document.getElementById('input_video')}); },
            width: 1280, height: 720, deviceId: $('#cam_select').val()
        });
        camera.start();
        isRunning = true;

        // --- LOGIKA COUNTDOWN ---
        playSfx(sfxStart); // Mulai suara arcade countdown
        
        let count = 3;
        const cdUi = $('#countdown-ui');
        cdUi.show().text(count);

        const timer = setInterval(() => {
            count--;
            if (count > 0) {
                cdUi.text(count);
            } else if (count === 0) {
                cdUi.text("GO!");
            } else {
                clearInterval(timer);
                cdUi.fadeOut(200);
                
                // Mulai Gameplay setelah countdown selesai
                for(let i=0; i<winScore; i++) { 
                    targets.push(createTarget(0)); 
                    targets.push(createTarget(1)); 
                }
                gameActive = true;
            }
        }, 1000); // Sinkron dengan 1 detik per angka
    }

    function onResults(results) {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        updateParticles();

        let detectedP1 = false, detectedP2 = false;

        if (results.multiHandLandmarks) {
            results.multiHandLandmarks.forEach(landmarks => {
                const rawX = landmarks[8].x * canvasElement.width;
                const rawY = landmarks[8].y * canvasElement.height;
                const isP1 = landmarks[8].x > 0.5;
                const pKey = isP1 ? 'p1' : 'p2';
                const neonColor = isP1 ? '#00d2ff' : '#ff007f';

                if(isP1) detectedP1 = true; else detectedP2 = true;

                if (!smoothPos[pKey].active) {
                    smoothPos[pKey].x = rawX;
                    smoothPos[pKey].y = rawY;
                    smoothPos[pKey].active = true;
                } else {
                    smoothPos[pKey].x = lerp(smoothPos[pKey].x, rawX, SMOOTH_FACTOR);
                    smoothPos[pKey].y = lerp(smoothPos[pKey].y, rawY, SMOOTH_FACTOR);
                }

                const fx = smoothPos[pKey].x;
                const fy = smoothPos[pKey].y;

                trailHistory[pKey].push({x: fx, y: fy});
                if(trailHistory[pKey].length > 15) trailHistory[pKey].shift();

                if(trailHistory[pKey].length > 2) {
                    canvasCtx.beginPath();
                    canvasCtx.lineWidth = 12;
                    canvasCtx.lineCap = 'round';
                    canvasCtx.strokeStyle = neonColor;
                    canvasCtx.shadowBlur = 15;
                    canvasCtx.shadowColor = neonColor;
                    for(let i=0; i < trailHistory[pKey].length - 1; i++) {
                        canvasCtx.globalAlpha = i / trailHistory[pKey].length;
                        canvasCtx.moveTo(trailHistory[pKey][i].x, trailHistory[pKey][i].y);
                        canvasCtx.lineTo(trailHistory[pKey][i+1].x, trailHistory[pKey][i+1].y);
                    }
                    canvasCtx.stroke();
                    canvasCtx.globalAlpha = 1.0;
                }

                canvasCtx.beginPath();
                canvasCtx.arc(fx, fy, 15, 0, Math.PI * 2);
                canvasCtx.fillStyle = "#fff";
                canvasCtx.shadowBlur = 20;
                canvasCtx.shadowColor = neonColor;
                canvasCtx.fill();
                canvasCtx.shadowBlur = 0;

                if(gameActive) {
                    targets.forEach(t => {
                        if (!t.active) return;
                        const tx = (t.baseX + Math.sin(t.phase) * 0.1) * canvasElement.width;
                        const ty = (t.baseY + Math.cos(t.phase) * 0.1) * canvasElement.height;
                        const dist = Math.sqrt((fx - tx)**2 + (fy - ty)**2);
                        if (dist < t.r + 20) {
                            if ((t.side === 0 && isP1) || (t.side === 1 && !isP1)) {
                                createExplosion(tx, ty, t.color);
                                if (t.side === 0) { scores.p1++; $('#p1-score').text(scores.p1); }
                                else { scores.p2++; $('#p2-score').text(scores.p2); }
                                playSfx(sfxSlice);
                                t.active = false;
                                checkWin();
                            }
                        }
                    });
                }
            });
        }

        if(!detectedP1) { smoothPos.p1.active = false; trailHistory.p1 = []; }
        if(!detectedP2) { smoothPos.p2.active = false; trailHistory.p2 = []; }

        if(gameActive) {
            targets.forEach(t => {
                if (!t.active) return;
                t.phase += t.speed;
                const tx = (t.baseX + Math.sin(t.phase) * 0.1) * canvasElement.width;
                const ty = (t.baseY + Math.cos(t.phase) * 0.1) * canvasElement.height;
                canvasCtx.beginPath();
                canvasCtx.arc(tx, ty, t.r, 0, Math.PI * 2);
                canvasCtx.fillStyle = t.color;
                canvasCtx.shadowBlur = 25;
                canvasCtx.shadowColor = t.color;
                canvasCtx.fill();
                canvasCtx.strokeStyle = "#fff";
                canvasCtx.lineWidth = 2;
                canvasCtx.stroke();
            });
        }
        canvasCtx.restore();
    }

    function checkWin() {
        if ((scores.p1 >= winScore || scores.p2 >= winScore) && gameActive) {
            gameActive = false; 
            playSfx(sfxOver);
            const winner = scores.p1 >= winScore ? "PLAYER 1" : "PLAYER 2";
            const winColor = scores.p1 >= winScore ? '#00d2ff' : '#ff007f';
            $('#winner-name').text(winner + " WINS!").css('color', winColor);
            $('#winner-display').fadeIn(500).css('display', 'flex');
        }
    }

    init();
</script>
</body>
</html>